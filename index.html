<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Calculate the last third of the night for Tahajjud prayer">
    <meta name="theme-color" content="#1e1b4b">
    <title>Tahajjud Time - Prayer Calculator</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect } from 'https://cdn.skypack.dev/react@18.2.0';
        import ReactDOM from 'https://cdn.skypack.dev/react-dom@18.2.0/client';
        import { Moon, Bell, BellOff, Clock, Sunrise, Sunset, Download } from 'https://cdn.skypack.dev/lucide-react@0.263.1';

        function TahajjudTime() {
            const [currentTime, setCurrentTime] = useState(new Date());
            const [sunsetTime, setSunsetTime] = useState('');
            const [dawnTime, setDawnTime] = useState('');
            const [lastThirdStart, setLastThirdStart] = useState(null);
            const [notificationsEnabled, setNotificationsEnabled] = useState(false);
            const [notificationSent, setNotificationSent] = useState(false);
            const [installPrompt, setInstallPrompt] = useState(null);
            const [isInstalled, setIsInstalled] = useState(false);

            // Load from localStorage on mount
            useEffect(() => {
                const savedSunset = localStorage.getItem('sunsetTime');
                const savedDawn = localStorage.getItem('dawnTime');
                const savedNotifications = localStorage.getItem('notificationsEnabled');

                if (savedSunset) setSunsetTime(savedSunset);
                if (savedDawn) setDawnTime(savedDawn);
                if (savedNotifications === 'true') setNotificationsEnabled(true);

                // Check if app is installed
                if (window.matchMedia('(display-mode: standalone)').matches) {
                    setIsInstalled(true);
                }
            }, []);

            // Register Service Worker
            useEffect(() => {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('sw.js').catch(err => {
                        console.log('Service Worker registration failed:', err);
                    });
                }

                // Listen for install prompt
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    setInstallPrompt(e);
                });

                window.addEventListener('appinstalled', () => {
                    setIsInstalled(true);
                    setInstallPrompt(null);
                });
            }, []);

            useEffect(() => {
                const timer = setInterval(() => {
                    setCurrentTime(new Date());
                }, 1000);
                return () => clearInterval(timer);
            }, []);

            useEffect(() => {
                if (sunsetTime && dawnTime) {
                    calculateLastThird();
                }
            }, [sunsetTime, dawnTime, currentTime]);

            // Save to localStorage when times change
            useEffect(() => {
                if (sunsetTime) localStorage.setItem('sunsetTime', sunsetTime);
            }, [sunsetTime]);

            useEffect(() => {
                if (dawnTime) localStorage.setItem('dawnTime', dawnTime);
            }, [dawnTime]);

            useEffect(() => {
                localStorage.setItem('notificationsEnabled', notificationsEnabled.toString());
            }, [notificationsEnabled]);

            const parseTime = (timeStr) => {
                const [hours, minutes] = timeStr.split(':').map(Number);
                const date = new Date();
                date.setHours(hours, minutes, 0, 0);
                return date;
            };

            const calculateLastThird = () => {
                const sunset = parseTime(sunsetTime);
                let dawn = parseTime(dawnTime);
                
                if (dawn < sunset) {
                    dawn.setDate(dawn.getDate() + 1);
                }

                const nightDuration = dawn - sunset;
                const lastThirdDuration = nightDuration / 3;
                const lastThird = new Date(dawn - lastThirdDuration);
                
                setLastThirdStart(lastThird);

                if (notificationsEnabled && !notificationSent && currentTime >= lastThird && currentTime < dawn) {
                    sendNotification();
                    setNotificationSent(true);
                }

                if (currentTime < lastThird || currentTime >= dawn) {
                    setNotificationSent(false);
                }
            };

            const sendNotification = () => {
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('Tahajjud Time', {
                        body: 'The last third of the night has begun. Time for Tahajjud prayer.',
                        icon: 'icon-192.png',
                        badge: 'icon-192.png',
                        tag: 'tahajjud-notification',
                        requireInteraction: true
                    });
                }
            };

            const toggleNotifications = async () => {
                if (!notificationsEnabled) {
                    if ('Notification' in window) {
                        const permission = await Notification.requestPermission();
                        if (permission === 'granted') {
                            setNotificationsEnabled(true);
                        }
                    }
                } else {
                    setNotificationsEnabled(false);
                }
            };

            const handleInstall = async () => {
                if (!installPrompt) return;
                
                installPrompt.prompt();
                const { outcome } = await installPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    setInstallPrompt(null);
                }
            };

            const getProgress = () => {
                if (!lastThirdStart || !sunsetTime || !dawnTime) return 0;

                const sunset = parseTime(sunsetTime);
                let dawn = parseTime(dawnTime);
                
                if (dawn < sunset) {
                    dawn.setDate(dawn.getDate() + 1);
                }

                const nightDuration = dawn - sunset;
                let elapsed = currentTime - sunset;

                if (currentTime < sunset) {
                    return 0;
                }
                if (currentTime > dawn) {
                    return 100;
                }

                return (elapsed / nightDuration) * 100;
            };

            const getTimeUntilLastThird = () => {
                if (!lastThirdStart) return null;

                const diff = lastThirdStart - currentTime;
                
                if (diff <= 0) {
                    const dawn = parseTime(dawnTime);
                    if (dawn < parseTime(sunsetTime)) {
                        dawn.setDate(dawn.getDate() + 1);
                    }
                    
                    if (currentTime < dawn) {
                        return { text: 'Last third is now!', color: 'text-green-400' };
                    }
                    return { text: 'Night has passed', color: 'text-gray-400' };
                }

                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                return {
                    text: `${hours}h ${minutes}m ${seconds}s`,
                    color: 'text-blue-400'
                };
            };

            const progress = getProgress();
            const countdown = getTimeUntilLastThird();
            const lastThirdProgress = progress >= 66.67;

            return React.createElement('div', { className: 'min-h-screen bg-gradient-to-br from-indigo-950 via-purple-950 to-slate-900 p-6 flex items-center justify-center' },
                React.createElement('div', { className: 'max-w-md w-full' },
                    React.createElement('div', { className: 'bg-slate-800/50 backdrop-blur-sm rounded-3xl shadow-2xl p-8 border border-slate-700/50' },
                        React.createElement('div', { className: 'flex items-center justify-center mb-8' },
                            React.createElement(Moon, { className: 'w-12 h-12 text-purple-400 mr-3' }),
                            React.createElement('h1', { className: 'text-4xl font-bold text-white' }, 'Tahajjud Time')
                        ),

                        React.createElement('div', { className: 'space-y-6 mb-8' },
                            React.createElement('div', null,
                                React.createElement('label', { className: 'flex items-center text-sm font-medium text-slate-300 mb-2' },
                                    React.createElement(Sunset, { className: 'w-4 h-4 mr-2 text-orange-400' }),
                                    'Sunset Time (Maghrib)'
                                ),
                                React.createElement('input', {
                                    type: 'time',
                                    value: sunsetTime,
                                    onChange: (e) => setSunsetTime(e.target.value),
                                    className: 'w-full px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-purple-500'
                                })
                            ),

                            React.createElement('div', null,
                                React.createElement('label', { className: 'flex items-center text-sm font-medium text-slate-300 mb-2' },
                                    React.createElement(Sunrise, { className: 'w-4 h-4 mr-2 text-yellow-400' }),
                                    'Dawn Time (Fajr)'
                                ),
                                React.createElement('input', {
                                    type: 'time',
                                    value: dawnTime,
                                    onChange: (e) => setDawnTime(e.target.value),
                                    className: 'w-full px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-purple-500'
                                })
                            )
                        ),

                        lastThirdStart && React.createElement('div', { className: 'space-y-6' },
                            React.createElement('div', { className: 'bg-slate-700/30 rounded-2xl p-6 border border-slate-600/30' },
                                React.createElement('div', { className: 'flex items-center justify-between mb-4' },
                                    React.createElement('span', { className: 'text-sm font-medium text-slate-300' }, 'Night Progress'),
                                    React.createElement('span', { className: 'text-sm text-slate-400' }, progress.toFixed(1) + '%')
                                ),
                                
                                React.createElement('div', { className: 'relative h-4 bg-slate-900/50 rounded-full overflow-hidden' },
                                    React.createElement('div', {
                                        className: 'absolute h-full bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 transition-all duration-1000 rounded-full',
                                        style: { width: `${progress}%` }
                                    }),
                                    React.createElement('div', {
                                        className: 'absolute h-full border-l-2 border-green-400',
                                        style: { left: '66.67%' }
                                    })
                                ),
                                
                                React.createElement('div', { className: 'flex justify-between mt-2 text-xs text-slate-400' },
                                    React.createElement('span', null, 'Sunset'),
                                    React.createElement('span', { className: 'text-green-400' }, 'Last Third'),
                                    React.createElement('span', null, 'Dawn')
                                )
                            ),

                            React.createElement('div', { className: 'text-center' },
                                React.createElement('div', { className: 'text-sm text-slate-400 mb-2' },
                                    lastThirdProgress ? 'Last third has begun' : 'Time until last third'
                                ),
                                React.createElement('div', { className: `text-5xl font-bold ${countdown?.color || 'text-white'} mb-2` },
                                    countdown?.text || '--:--:--'
                                ),
                                React.createElement('div', { className: 'text-sm text-slate-400' },
                                    'Last third starts at ' + lastThirdStart.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
                                )
                            ),

                            React.createElement('button', {
                                onClick: toggleNotifications,
                                className: `w-full flex items-center justify-center gap-3 py-4 rounded-xl font-semibold transition-all ${
                                    notificationsEnabled
                                        ? 'bg-green-600 hover:bg-green-700 text-white'
                                        : 'bg-slate-700 hover:bg-slate-600 text-slate-300'
                                }`
                            },
                                notificationsEnabled ? React.createElement(Bell, { className: 'w-5 h-5' }) : React.createElement(BellOff, { className: 'w-5 h-5' }),
                                notificationsEnabled ? 'Notifications On' : 'Enable Notifications'
                            ),

                            installPrompt && !isInstalled && React.createElement('button', {
                                onClick: handleInstall,
                                className: 'w-full flex items-center justify-center gap-3 py-4 rounded-xl font-semibold transition-all bg-purple-600 hover:bg-purple-700 text-white pulse'
                            },
                                React.createElement(Download, { className: 'w-5 h-5' }),
                                'Install App'
                            ),

                            React.createElement('div', { className: 'text-center text-xs text-slate-500 mt-4' },
                                React.createElement(Clock, { className: 'w-3 h-3 inline mr-1' }),
                                'Current time: ' + currentTime.toLocaleTimeString()
                            )
                        ),

                        !sunsetTime && !dawnTime && React.createElement('div', { className: 'text-center py-8 text-slate-400' },
                            React.createElement(Moon, { className: 'w-16 h-16 mx-auto mb-4 opacity-50' }),
                            React.createElement('p', null, 'Enter sunset and dawn times to begin')
                        )
                    ),

                    React.createElement('div', { className: 'mt-6 text-center text-xs text-slate-500' },
                        React.createElement('p', null, 'The last third of the night is the most blessed time for Tahajjud prayer')
                    )
                )
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(TahajjudTime));
    </script>
</body>
</html>
