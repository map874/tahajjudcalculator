<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#000" />

  <title>Last Third of the Night Calculator ‚Äì Best Time for Tahajjud</title>
  <meta name="description" content="Find the exact time for Tahajjud prayer based on your location. Use our free, easy-to-use Tahajjud time calculator and boost your night prayer routine." />
  <meta name="keywords" content="tahajjud time, tahajjud prayer, last third of night, night prayer, qiyam al layl, tahajjud calculator, islamic prayer times" />

  <!-- Open Graph -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://tahajjudtime.com/" />
  <meta property="og:title" content="Tahajjud Time Calculator ‚Äì Best Time for Night Prayer" />
  <meta property="og:description" content="Find the exact time for Tahajjud prayer based on your location. Free and accurate calculator to help you pray at the best time." />
  <meta property="og:image" content="https://tahajjudtime.com/og-image.jpg" />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:url" content="https://tahajjudtime.com/" />
  <meta name="twitter:title" content="Tahajjud Time Calculator ‚Äì Best Time for Night Prayer" />
  <meta name="twitter:description" content="Free and accurate Tahajjud prayer time calculator based on your location. Start praying Tahajjud at the best possible time." />
  <meta name="twitter:image" content="https://tahajjudtime.com/og-image.jpg" />

  <!-- Icons & PWA -->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">

  <!-- Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "Tahajjud Time",
    "url": "https://tahajjudtime.com/",
    "description": "Free online tool to calculate Tahajjud prayer time based on location and help Muslims pray at the best time.",
    "potentialAction": {
      "@type": "SearchAction",
      "target": "https://tahajjudtime.com/?q={search_term_string}",
      "query-input": "required name=search_term_string"
    }
  }
  </script>

  <style>
  html, body {
    margin: 0;
    padding: 0;
    font-family: 'Inter', sans-serif;
    background: #000;
    color: #eee;
    -webkit-tap-highlight-color: transparent;
  }

  #starCanvas {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 220px;
    z-index: -1;
  }

  .container {
    background: rgba(30,30,30,0.95);
    padding: 1.5rem;
    border-radius: 1rem;
    box-shadow: 0 8px 20px rgba(0,0,0,0.7);
    max-width: 90%;
    margin: 2rem auto;
    text-align: center;
  }

  h2 { font-size: clamp(1.3rem, 5vw, 1.7rem); margin-bottom: 1rem; }

  label {
    display: block;
    margin: 0.7rem 0 0.3rem;
    font-size: 0.85rem;
    color: #bbb;
    text-align: left;
  }

  input {
    width: 100%;
    padding: 0.7rem;
    font-size: 1rem;
    border: 1px solid #555;
    border-radius: 0.5rem;
    background: #222;
    color: #eee;
  }

  input:focus {
    border-color: #4CAF50;
    box-shadow: 0 0 0 3px rgba(76,175,80,0.3);
  }

  button {
    margin-top: 1rem;
    background: #4CAF50;
    color: white;
    padding: 0.9rem;
    border: none;
    border-radius: 0.6rem;
    cursor: pointer;
    font-size: 1.05rem;
    min-height: 48px;
    width: 100%;
    transition: transform 0.15s ease, background 0.2s ease;
  }

  button:hover { background: #43a047; transform: scale(1.02); }

  .result, .countdown {
    margin-top: 1rem;
    font-size: 0.95rem;
    font-weight: 500;
  }

  .result b { color: #4CAF50; }

  .progress-container { margin-top: 1rem; }
  .progress-bar {
    height: 14px;
    border-radius: 8px;
    background: #333;
    position: relative;
    overflow: hidden;
  }

  .progress-last-third {
    position: absolute;
    top: 0;
    height: 100%;
    background: #4CAF50;
  }

  .disclaimer {
    font-size: 0.75rem;
    margin-top: 1rem;
    color: #888;
  }
  </style>
</head>
<body>
<canvas id="starCanvas"></canvas>

<div class="container">
  <h2>üåô Last Third of the Night</h2>

  <button onclick="useLocation()" aria-label="Use current location for prayer times">üìç Get Prayer Times Automatically</button>

  <label>Maghrib (Sunset) Time</label>
  <input type="time" id="maghrib" />

  <label>Fajr Time</label>
  <input type="time" id="fajr" />

  <button onclick="calculateLastThird()" aria-label="Calculate last third of the night">Calculate</button>

  <div class="result" id="result"></div>
  <div class="countdown" id="countdown"></div>

  <div class="progress-container">
    <div class="progress-bar">
      <div class="progress-last-third" id="lastThirdBar"></div>
    </div>
  </div>

  <div class="disclaimer">‚ö†Ô∏è Automatic prayer times may not be accurate and may need adjusting manually.</div>
</div>

<script>
// ---- Starry Background ----
const canvas = document.getElementById('starCanvas');
const ctx = canvas.getContext('2d');
let stars = [];
function resizeCanvas(){ canvas.width=window.innerWidth; canvas.height=220; }
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

for (let i=0;i<120;i++){
  stars.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,r:Math.random()*1.2,dx:(Math.random()-0.5)/3,dy:(Math.random()-0.5)/3});
}

function animateStars(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const grad=ctx.createLinearGradient(0,0,0,canvas.height);
  grad.addColorStop(0,'#000'); grad.addColorStop(1,'#222');
  ctx.fillStyle=grad; ctx.fillRect(0,0,canvas.width,canvas.height);
  stars.forEach(s=>{
    ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2);
    ctx.fillStyle='#fff'; ctx.fill();
    s.x+=s.dx; s.y+=s.dy;
    if(s.x<0)s.x=canvas.width; if(s.x>canvas.width)s.x=0;
    if(s.y<0)s.y=canvas.height; if(s.y>canvas.height)s.y=0;
  });
  if(!document.hidden) requestAnimationFrame(animateStars);
}
animateStars();
document.addEventListener('visibilitychange',()=>{ if(!document.hidden) animateStars(); });

// ---- Utilities ----
const toMinutes=t=>{const [h,m]=t.split(":").map(Number);return h*60+m;};
const toTimeString=m=>{m=Math.ceil(m);let h=Math.floor(m/60)%24,x=m%60;return `${h.toString().padStart(2,"0")}:${x.toString().padStart(2,"0")}`;};

let lastThirdStart=0, fajrMins=0, maghribMins=0;

function calculateLastThird(){
  const maghrib=document.getElementById("maghrib").value;
  const fajr=document.getElementById("fajr").value;
  if(!maghrib||!fajr){document.getElementById("result").innerText="‚ö†Ô∏è Please enter both times.";return;}
  maghribMins=toMinutes(maghrib);
  fajrMins=toMinutes(fajr);
  if(fajrMins<maghribMins) fajrMins+=1440;
  const night=fajrMins-maghribMins;
  lastThirdStart=fajrMins-night/3;

  document.getElementById("result").innerHTML=`The last third of the night is:<br><b>${toTimeString(lastThirdStart)}</b> ‚Üí <b>${toTimeString(fajrMins)}</b>`;
  const left=((lastThirdStart-maghribMins)/night)*100;
  const width=((fajrMins-lastThirdStart)/night)*100;
  const bar=document.getElementById("lastThirdBar");
  bar.style.left=left+"%"; bar.style.width=width+"%";

  startCountdown();
  scheduleNotification();
}

function startCountdown(){
  const el=document.getElementById("countdown");
  function tick(){
    const now=new Date();
    let mins=now.getHours()*60+now.getMinutes()+now.getSeconds()/60;
    let diff=Math.max(0,lastThirdStart-mins);
    const h=Math.floor(diff/60), m=Math.floor(diff%60), s=Math.floor((diff-Math.floor(diff))*60);
    el.textContent=diff>0?`Countdown to last third: ${h}h ${m}m ${s}s`:`Last third has started!`;
    requestAnimationFrame(tick);
  }
  tick();
}

async function useLocation(){
  if(!navigator.geolocation){alert("Geolocation not supported.");return;}
  navigator.geolocation.getCurrentPosition(async pos=>{
    const {latitude,longitude}=pos.coords;
    try{
      const controller=new AbortController();
      const timeout=setTimeout(()=>controller.abort(),6000);
      const res=await fetch(`https://api.aladhan.com/v1/timings?latitude=${latitude}&longitude=${longitude}&method=2`,{signal:controller.signal});
      clearTimeout(timeout);
      const data=await res.json();
      document.getElementById("maghrib").value=data.data.timings.Maghrib.slice(0,5);
      document.getElementById("fajr").value=data.data.timings.Fajr.slice(0,5);
      calculateLastThird();
    }catch(e){alert("Could not fetch prayer times.");}
  },()=>alert("Location permission denied."));
}

function scheduleNotification(){
  if(!("Notification" in window))return;
  Notification.requestPermission().then(p=>{
    if(p!=="granted")return;
    const notifTime=new Date();
    notifTime.setHours(Math.floor(lastThirdStart/60),lastThirdStart%60,0,0);
    const delay=notifTime-new Date();
    if(delay>0)setTimeout(()=>new Notification("üåô Last Third Reminder",{body:"It's time for the last third of the night!"}),delay);
  });
}
</script>
</body>
</html>
