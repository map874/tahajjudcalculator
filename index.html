import React, { useState, useEffect } from 'react';
import { Moon, Bell, BellOff, Clock, Sunrise, Sunset, Download } from 'lucide-react';

export default function TahajjudTime() {
  const [currentTime, setCurrentTime] = useState(new Date());
  const [sunsetTime, setSunsetTime] = useState('');
  const [dawnTime, setDawnTime] = useState('');
  const [lastThirdStart, setLastThirdStart] = useState(null);
  const [notificationsEnabled, setNotificationsEnabled] = useState(false);
  const [notificationSent, setNotificationSent] = useState(false);
  const [installPrompt, setInstallPrompt] = useState(null);
  const [isInstalled, setIsInstalled] = useState(false);

  useEffect(() => {
    const savedSunset = localStorage.getItem('sunsetTime');
    const savedDawn = localStorage.getItem('dawnTime');
    const savedNotifications = localStorage.getItem('notificationsEnabled');

    if (savedSunset) setSunsetTime(savedSunset);
    if (savedDawn) setDawnTime(savedDawn);
    if (savedNotifications === 'true') setNotificationsEnabled(true);

    if (window.matchMedia('(display-mode: standalone)').matches) {
      setIsInstalled(true);
    }
  }, []);

  useEffect(() => {
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(err => {
        console.log('Service Worker registration failed:', err);
      });
    }

    const handleBeforeInstall = (e) => {
      e.preventDefault();
      setInstallPrompt(e);
    };

    const handleAppInstalled = () => {
      setIsInstalled(true);
      setInstallPrompt(null);
    };

    window.addEventListener('beforeinstallprompt', handleBeforeInstall);
    window.addEventListener('appinstalled', handleAppInstalled);

    return () => {
      window.removeEventListener('beforeinstallprompt', handleBeforeInstall);
      window.removeEventListener('appinstalled', handleAppInstalled);
    };
  }, []);

  useEffect(() => {
    const timer = setInterval(() => {
      setCurrentTime(new Date());
    }, 1000);
    return () => clearInterval(timer);
  }, []);

  useEffect(() => {
    if (sunsetTime && dawnTime) {
      calculateLastThird();
    }
  }, [sunsetTime, dawnTime, currentTime]);

  useEffect(() => {
    if (sunsetTime) localStorage.setItem('sunsetTime', sunsetTime);
  }, [sunsetTime]);

  useEffect(() => {
    if (dawnTime) localStorage.setItem('dawnTime', dawnTime);
  }, [dawnTime]);

  useEffect(() => {
    localStorage.setItem('notificationsEnabled', notificationsEnabled.toString());
  }, [notificationsEnabled]);

  const parseTime = (timeStr) => {
    const [hours, minutes] = timeStr.split(':').map(Number);
    const date = new Date();
    date.setHours(hours, minutes, 0, 0);
    return date;
  };

  const calculateLastThird = () => {
    const sunset = parseTime(sunsetTime);
    let dawn = parseTime(dawnTime);
    
    if (dawn < sunset) {
      dawn.setDate(dawn.getDate() + 1);
    }

    const nightDuration = dawn - sunset;
    const lastThirdDuration = nightDuration / 3;
    const lastThird = new Date(dawn - lastThirdDuration);
    
    setLastThirdStart(lastThird);

    if (notificationsEnabled && !notificationSent && currentTime >= lastThird && currentTime < dawn) {
      sendNotification();
      setNotificationSent(true);
    }

    if (currentTime < lastThird || currentTime >= dawn) {
      setNotificationSent(false);
    }
  };

  const sendNotification = () => {
    if ('Notification' in window && Notification.permission === 'granted') {
      new Notification('Tahajjud Time', {
        body: 'The last third of the night has begun. Time for Tahajjud prayer.',
        icon: 'ðŸŒ™',
        tag: 'tahajjud-notification',
        requireInteraction: true
      });
    }
  };

  const toggleNotifications = async () => {
    if (!notificationsEnabled) {
      if ('Notification' in window) {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
          setNotificationsEnabled(true);
        }
      }
    } else {
      setNotificationsEnabled(false);
    }
  };

  const handleInstall = async () => {
    if (!installPrompt) return;
    
    installPrompt.prompt();
    const { outcome } = await installPrompt.userChoice;
    
    if (outcome === 'accepted') {
      setInstallPrompt(null);
    }
  };

  const getProgress = () => {
    if (!lastThirdStart || !sunsetTime || !dawnTime) return 0;

    const sunset = parseTime(sunsetTime);
    let dawn = parseTime(dawnTime);
    
    if (dawn < sunset) {
      dawn.setDate(dawn.getDate() + 1);
    }

    const nightDuration = dawn - sunset;
    let elapsed = currentTime - sunset;

    if (currentTime < sunset) {
      return 0;
    }
    if (currentTime > dawn) {
      return 100;
    }

    return (elapsed / nightDuration) * 100;
  };

  const getTimeUntilLastThird = () => {
    if (!lastThirdStart) return null;

    const diff = lastThirdStart - currentTime;
    
    if (diff <= 0) {
      const dawn = parseTime(dawnTime);
      if (dawn < parseTime(sunsetTime)) {
        dawn.setDate(dawn.getDate() + 1);
      }
      
      if (currentTime < dawn) {
        return { text: 'Last third is now!', color: 'text-green-400' };
      }
      return { text: 'Night has passed', color: 'text-gray-400' };
    }

    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((diff % (1000 * 60)) / 1000);

    return {
      text: `${hours}h ${minutes}m ${seconds}s`,
      color: 'text-blue-400'
    };
  };

  const progress = getProgress();
  const countdown = getTimeUntilLastThird();
  const lastThirdProgress = progress >= 66.67;

  return (
    <div className="min-h-screen bg-gradient-to-br from-indigo-950 via-purple-950 to-slate-900 p-6 flex items-center justify-center">
      <div className="max-w-md w-full">
        <div className="bg-slate-800/50 backdrop-blur-sm rounded-3xl shadow-2xl p-8 border border-slate-700/50">
          <div className="flex items-center justify-center mb-8">
            <Moon className="w-12 h-12 text-purple-400 mr-3" />
            <h1 className="text-4xl font-bold text-white">Tahajjud Time</h1>
          </div>

          <div className="space-y-6 mb-8">
            <div>
              <label className="flex items-center text-sm font-medium text-slate-300 mb-2">
                <Sunset className="w-4 h-4 mr-2 text-orange-400" />
                Sunset Time (Maghrib)
              </label>
              <input
                type="time"
                value={sunsetTime}
                onChange={(e) => setSunsetTime(e.target.value)}
                className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
              />
            </div>

            <div>
              <label className="flex items-center text-sm font-medium text-slate-300 mb-2">
                <Sunrise className="w-4 h-4 mr-2 text-yellow-400" />
                Dawn Time (Fajr)
              </label>
              <input
                type="time"
                value={dawnTime}
                onChange={(e) => setDawnTime(e.target.value)}
                className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
              />
            </div>
          </div>

          {lastThirdStart && (
            <div className="space-y-6">
              <div className="bg-slate-700/30 rounded-2xl p-6 border border-slate-600/30">
                <div className="flex items-center justify-between mb-4">
                  <span className="text-sm font-medium text-slate-300">Night Progress</span>
                  <span className="text-sm text-slate-400">{progress.toFixed(1)}%</span>
                </div>
                
                <div className="relative h-4 bg-slate-900/50 rounded-full overflow-hidden">
                  <div
                    className="absolute h-full bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 transition-all duration-1000 rounded-full"
                    style={{ width: `${progress}%` }}
                  />
                  <div
                    className="absolute h-full border-l-2 border-green-400"
                    style={{ left: '66.67%' }}
                  />
                </div>
                
                <div className="flex justify-between mt-2 text-xs text-slate-400">
                  <span>Sunset</span>
                  <span className="text-green-400">Last Third</span>
                  <span>Dawn</span>
                </div>
              </div>

              <div className="text-center">
                <div className="text-sm text-slate-400 mb-2">
                  {lastThirdProgress ? 'Last third has begun' : 'Time until last third'}
                </div>
                <div className={`text-5xl font-bold ${countdown?.color || 'text-white'} mb-2`}>
                  {countdown?.text || '--:--:--'}
                </div>
                <div className="text-sm text-slate-400">
                  Last third starts at {lastThirdStart.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}
                </div>
              </div>

              <button
                onClick={toggleNotifications}
                className={`w-full flex items-center justify-center gap-3 py-4 rounded-xl font-semibold transition-all ${
                  notificationsEnabled
                    ? 'bg-green-600 hover:bg-green-700 text-white'
                    : 'bg-slate-700 hover:bg-slate-600 text-slate-300'
                }`}
              >
                {notificationsEnabled ? <Bell className="w-5 h-5" /> : <BellOff className="w-5 h-5" />}
                {notificationsEnabled ? 'Notifications On' : 'Enable Notifications'}
              </button>

              {installPrompt && !isInstalled && (
                <button
                  onClick={handleInstall}
                  className="w-full flex items-center justify-center gap-3 py-4 rounded-xl font-semibold transition-all bg-purple-600 hover:bg-purple-700 text-white"
                  style={{ animation: 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite' }}
                >
                  <Download className="w-5 h-5" />
                  Install App
                </button>
              )}

              <div className="text-center text-xs text-slate-500 mt-4">
                <Clock className="w-3 h-3 inline mr-1" />
                Current time: {currentTime.toLocaleTimeString()}
              </div>
            </div>
          )}

          {!sunsetTime && !dawnTime && (
            <div className="text-center py-8 text-slate-400">
              <Moon className="w-16 h-16 mx-auto mb-4 opacity-50" />
              <p>Enter sunset and dawn times to begin</p>
            </div>
          )}
        </div>

        <div className="mt-6 text-center text-xs text-slate-500">
          <p>The last third of the night is the most blessed time for Tahajjud prayer</p>
        </div>
      </div>
    </div>
  );
}
