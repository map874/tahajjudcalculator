<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Calculate the last third of the night for Tahajjud prayer">
    <meta name="theme-color" content="#1e1b4b">
    <title>Tahajjud Time - Prayer Calculator</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="android-chrome-192x192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse-anim { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body>
    <div id="app"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const Moon = ({ className = '', size = 24 }) => (
            <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/>
            </svg>
        );

        const Bell = ({ className = '', size = 24 }) => (
            <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/>
                <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/>
            </svg>
        );

        const BellOff = ({ className = '', size = 24 }) => (
            <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M8.7 3A6 6 0 0 1 18 8a21.3 21.3 0 0 0 .6 5"/>
                <path d="M17 17H3s3-2 3-9a4.67 4.67 0 0 1 .3-1.7"/>
                <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/>
                <path d="m2 2 20 20"/>
            </svg>
        );

        const Clock = ({ className = '', size = 24 }) => (
            <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
            </svg>
        );

        const Sunrise = ({ className = '', size = 24 }) => (
            <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M12 2v8"/>
                <path d="m4.93 10.93 1.41 1.41"/>
                <path d="M2 18h2"/>
                <path d="M20 18h2"/>
                <path d="m19.07 10.93-1.41 1.41"/>
                <path d="M22 22H2"/>
                <path d="m8 6 4-4 4 4"/>
                <path d="M16 18a4 4 0 0 0-8 0"/>
            </svg>
        );

        const Sunset = ({ className = '', size = 24 }) => (
            <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M12 10V2"/>
                <path d="m4.93 10.93 1.41 1.41"/>
                <path d="M2 18h2"/>
                <path d="M20 18h2"/>
                <path d="m19.07 10.93-1.41 1.41"/>
                <path d="M22 22H2"/>
                <path d="m16 6-4 4-4-4"/>
                <path d="M16 18a4 4 0 0 0-8 0"/>
            </svg>
        );

        const Download = ({ className = '', size = 24 }) => (
            <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" x2="12" y1="15" y2="3"/>
            </svg>
        );

        function TahajjudTime() {
            const [currentTime, setCurrentTime] = useState(new Date());
            const [sunsetTime, setSunsetTime] = useState('');
            const [dawnTime, setDawnTime] = useState('');
            const [lastThirdStart, setLastThirdStart] = useState(null);
            const [notificationsEnabled, setNotificationsEnabled] = useState(false);
            const [notificationSent, setNotificationSent] = useState(false);
            const [installPrompt, setInstallPrompt] = useState(null);
            const [isInstalled, setIsInstalled] = useState(false);

            useEffect(() => {
                const savedSunset = localStorage.getItem('sunsetTime');
                const savedDawn = localStorage.getItem('dawnTime');
                const savedNotifications = localStorage.getItem('notificationsEnabled');

                if (savedSunset) setSunsetTime(savedSunset);
                if (savedDawn) setDawnTime(savedDawn);
                if (savedNotifications === 'true') setNotificationsEnabled(true);

                if (window.matchMedia('(display-mode: standalone)').matches) {
                    setIsInstalled(true);
                }
            }, []);

            useEffect(() => {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('sw.js').catch(err => {
                        console.log('Service Worker registration failed:', err);
                    });
                }

                const handleBeforeInstall = (e) => {
                    e.preventDefault();
                    setInstallPrompt(e);
                };

                const handleAppInstalled = () => {
                    setIsInstalled(true);
                    setInstallPrompt(null);
                };

                window.addEventListener('beforeinstallprompt', handleBeforeInstall);
                window.addEventListener('appinstalled', handleAppInstalled);

                return () => {
                    window.removeEventListener('beforeinstallprompt', handleBeforeInstall);
                    window.removeEventListener('appinstalled', handleAppInstalled);
                };
            }, []);

            useEffect(() => {
                const timer = setInterval(() => {
                    setCurrentTime(new Date());
                }, 1000);
                return () => clearInterval(timer);
            }, []);

            useEffect(() => {
                if (sunsetTime && dawnTime) {
                    calculateLastThird();
                }
            }, [sunsetTime, dawnTime, currentTime]);

            useEffect(() => {
                if (sunsetTime) localStorage.setItem('sunsetTime', sunsetTime);
            }, [sunsetTime]);

            useEffect(() => {
                if (dawnTime) localStorage.setItem('dawnTime', dawnTime);
            }, [dawnTime]);

            useEffect(() => {
                localStorage.setItem('notificationsEnabled', notificationsEnabled.toString());
            }, [notificationsEnabled]);

            const parseTime = (timeStr) => {
                const [hours, minutes] = timeStr.split(':').map(Number);
                const date = new Date();
                date.setHours(hours, minutes, 0, 0);
                return date;
            };

            const calculateLastThird = () => {
                const sunset = parseTime(sunsetTime);
                let dawn = parseTime(dawnTime);
                
                if (dawn < sunset) {
                    dawn.setDate(dawn.getDate() + 1);
                }

                const nightDuration = dawn - sunset;
                const lastThirdDuration = nightDuration / 3;
                const lastThird = new Date(dawn - lastThirdDuration);
                
                setLastThirdStart(lastThird);

                if (notificationsEnabled && !notificationSent && currentTime >= lastThird && currentTime < dawn) {
                    sendNotification();
                    setNotificationSent(true);
                }

                if (currentTime < lastThird || currentTime >= dawn) {
                    setNotificationSent(false);
                }
            };

            const sendNotification = () => {
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('Tahajjud Time', {
                        body: 'The last third of the night has begun. Time for Tahajjud prayer.',
                        icon: 'android-chrome-192x192.png',
                        tag: 'tahajjud-notification',
                        requireInteraction: true
                    });
                }
            };

            const toggleNotifications = async () => {
                if (!notificationsEnabled) {
                    if ('Notification' in window) {
                        const permission = await Notification.requestPermission();
                        if (permission === 'granted') {
                            setNotificationsEnabled(true);
                        }
                    }
                } else {
                    setNotificationsEnabled(false);
                }
            };

            const handleInstall = async () => {
                if (!installPrompt) return;
                
                installPrompt.prompt();
                const result = await installPrompt.userChoice;
                
                if (result.outcome === 'accepted') {
                    setInstallPrompt(null);
                }
            };

            const getProgress = () => {
                if (!lastThirdStart || !sunsetTime || !dawnTime) return 0;

                const sunset = parseTime(sunsetTime);
                let dawn = parseTime(dawnTime);
                
                if (dawn < sunset) {
                    dawn.setDate(dawn.getDate() + 1);
                }

                const nightDuration = dawn - sunset;
                let elapsed = currentTime - sunset;

                if (currentTime < sunset) {
                    return 0;
                }
                if (currentTime > dawn) {
                    return 100;
                }

                return (elapsed / nightDuration) * 100;
            };

            const getTimeUntilLastThird = () => {
                if (!lastThirdStart) return null;

                const diff = lastThirdStart - currentTime;
                
                if (diff <= 0) {
                    const dawn = parseTime(dawnTime);
                    if (dawn < parseTime(sunsetTime)) {
                        dawn.setDate(dawn.getDate() + 1);
                    }
                    
                    if (currentTime < dawn) {
                        return { text: 'Last third is now!', color: 'text-green-400' };
                    }
                    return { text: 'Night has passed', color: 'text-gray-400' };
                }

                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                return {
                    text: `${hours}h ${minutes}m ${seconds}s`,
                    color: 'text-blue-400'
                };
            };

            const progress = getProgress();
            const countdown = getTimeUntilLastThird();
            const lastThirdProgress = progress >= 66.67;

            return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-950 via-purple-950 to-slate-900 p-6 flex items-center justify-center">
                    <div className="max-w-md w-full">
                        <div className="bg-slate-800/50 backdrop-blur-sm rounded-3xl shadow-2xl p-8 border border-slate-700/50">
                            <div className="flex items-center justify-center mb-8">
                                <Moon className="text-purple-400 mr-3" size={48} />
                                <h1 className="text-4xl font-bold text-white">Tahajjud Time</h1>
                            </div>

                            <div className="space-y-6 mb-8">
                                <div>
                                    <label className="flex items-center text-sm font-medium text-slate-300 mb-2">
                                        <Sunset className="text-orange-400 mr-2" size={16} />
                                        Sunset Time (Maghrib)
                                    </label>
                                    <input
                                        type="time"
                                        value={sunsetTime}
                                        onChange={(e) => setSunsetTime(e.target.value)}
                                        className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                                    />
                                </div>

                                <div>
                                    <label className="flex items-center text-sm font-medium text-slate-300 mb-2">
                                        <Sunrise className="text-yellow-400 mr-2" size={16} />
                                        Dawn Time (Fajr)
                                    </label>
                                    <input
                                        type="time"
                                        value={dawnTime}
                                        onChange={(e) => setDawnTime(e.target.value)}
                                        className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                                    />
                                </div>
                            </div>

                            {lastThirdStart && (
                                <div className="space-y-6">
                                    <div className="bg-slate-700/30 rounded-2xl p-6 border border-slate-600/30">
                                        <div className="flex items-center justify-between mb-4">
                                            <span className="text-sm font-medium text-slate-300">Night Progress</span>
                                            <span className="text-sm text-slate-400">{progress.toFixed(1)}%</span>
                                        </div>
                                        
                                        <div className="relative h-4 bg-slate-900/50 rounded-full overflow-hidden">
                                            <div
                                                className="absolute h-full bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 transition-all duration-1000 rounded-full"
                                                style={{ width: `${progress}%` }}
                                            />
                                            <div
                                                className="absolute h-full border-l-2 border-green-400"
                                                style={{ left: '66.67%' }}
                                            />
                                        </div>
                                        
                                        <div className="flex justify-between mt-2 text-xs text-slate-400">
                                            <span>Sunset</span>
                                            <span className="text-green-400">Last Third</span>
                                            <span>Dawn</span>
                                        </div>
                                    </div>

                                    <div className="text-center">
                                        <div className="text-sm text-slate-400 mb-2">
                                            {lastThirdProgress ? 'Last third has begun' : 'Time until last third'}
                                        </div>
                                        <div className={`text-5xl font-bold ${countdown?.color || 'text-white'} mb-2`}>
                                            {countdown?.text || '--:--:--'}
                                        </div>
                                        <div className="text-sm text-slate-400">
                                            Last third starts at {lastThirdStart.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}
                                        </div>
                                    </div>

                                    <button
                                        onClick={toggleNotifications}
                                        className={`w-full flex items-center justify-center gap-3 py-4 rounded-xl font-semibold transition-all ${
                                            notificationsEnabled
                                                ? 'bg-green-600 hover:bg-green-700 text-white'
                                                : 'bg-slate-700 hover:bg-slate-600 text-slate-300'
                                        }`}
                                    >
                                        {notificationsEnabled ? <Bell size={20} /> : <BellOff size={20} />}
                                        {notificationsEnabled ? 'Notifications On' : 'Enable Notifications'}
                                    </button>

                                    {installPrompt && !isInstalled && (
                                        <button
                                            onClick={handleInstall}
                                            className="w-full flex items-center justify-center gap-3 py-4 rounded-xl font-semibold transition-all bg-purple-600 hover:bg-purple-700 text-white pulse-anim"
                                        >
                                            <Download size={20} />
                                            Install App
                                        </button>
                                    )}

                                    <div className="text-center text-xs text-slate-500 mt-4">
                                        <Clock className="inline mr-1" size={12} />
                                        Current time: {currentTime.toLocaleTimeString()}
                                    </div>
                                </div>
                            )}

                            {!sunsetTime && !dawnTime && (
                                <div className="text-center py-8 text-slate-400">
                                    <Moon className="mx-auto mb-4 opacity-50" size={64} />
                                    <p>Enter sunset and dawn times to begin</p>
                                </div>
                            )}
                        </div>

                        <div className="mt-6 text-center text-xs text-slate-500">
                            <p>The last third of the night is the most blessed time for Tahajjud prayer</p>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('app'));
        root.render(<TahajjudTime />);
    </script>
</body>
</html>
